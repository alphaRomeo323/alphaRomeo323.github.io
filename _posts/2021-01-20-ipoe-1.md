---
layout: post
title: "niftyでIPv4 over IPv6がつながらない事象"
date: 2021-01-20 16:30:00 +0900
categories: develop_and_server
lang: ja
---

α Romeo です。

今回家の回線を IPv4 over IPv6(所謂IPoE)にしてみた時の備忘録的 something を残しておこうと思います。

## IPv4 over IPv6 とは

IPv4 over IPv6とは、IPv6用の回線でIPv4を運用するというものです。

通常IPv4はPPPoEと呼ばれるプロトコルが用いられており、これによると回線事業者(NTT)がプロバイダの認証を行うため、回線事業者のサーバーの混雑度で回線速度が左右されてしまうそう。

一方IPv4 over IPv6では、プロバイダの認証は回線事業者ではなくプロバイダが行うため、回線事業者の混雑度の影響を比較的受けづらい、とのタレコミです。

こちらが今回契約したものです。~~というか3年前今の家に引っ越した時には使えるようになってました~~

[nifty 光 IPv6 サービス](https://csoption.nifty.com/ipv6service/)

ピーク時間帯の回線速度を上げるためにと親からの命令(?)によってこれを使えるようにするよう頑張ってみました。

## いざIPoE
IPv6の特権、IPoEの特徴は、**設定はプロバイダがやってくれるから使用者は何もしなくていい**。

素晴らしい。素敵。

PPPoEからIPoEに変える際には
1. 既存のPPPoEプロバイダ設定を無効化または削除
2. ホームゲートウェイを再起動
3. **It's no STEP 3 lol**

とまあ往時のiMacのCMそのものです。

## ところが

上記の通りにIPoEに変更したところ、**ほとんどのサイトにアクセスができなくなる**という事態に

GoogleやYoutubeだけは使えるんだよなぁ…

nslookupは通る…けどpingができない…

どうやら**IPv6のサイトには接続できるがIPv4だけのサイトには接続できない**という事案が発生。

あっれ～？

深夜帯3時間をこの原因究明に費やしてJava開発環境構築と課題研究と睡眠の時間を棒に振る結果となりました。許せん

##原因
### 1. 光電話オプションの通信方式がタイプ1

次の日、重い瞼をこすりながら調べて見たところ、どうやら**光電話のオプションがタイプ1であるから**かもしれないしれんとのこと。

[こちらのサイトによれば、](https://www.odorikoblog.net/entry/fletsjoint/)IPv4 over IPv6は「フレッツ・ジョイント」と呼ばれる機能によって実装されている、とのこと。

このフレッツ・ジョイントは光電話オプションの通信方式がタイプ2であるときにのみ使用可能だそうだ。

物心ついた時からブロードバンド回線であった我が家だったので、「これはあるかもしれない」と親にけしかけてNTTに問い合わせたところ

**タイプ1でした**

**速攻でタイプ2にしてもらいました。**

**1時間かからずにタイプ2になりました。**

**これまで参考として見ていたサイトにあって自宅のHGWになかった設定が突如登場しました**  
例えばローカルDNS問い合わせとか。

IPv4 over IPv6を使いたいと思っているインターネット老人の皆さん、気を付けてくださいね。

### 2. HGWではなくその先のルーターでIPoEを受ける前提の契約だった

ここで意気揚々とIPoEをセットアップしてみましたが、**やはりIPv4のサイトだけつながらない…**

そういえば契約内容を見て、HGWでのIPoE接続設定がOFFになっていることが気になり、とりあえず、という気持ちでniftyに問い合わせました。

ちなみに問い合わせ前段階で親から「言いくるめられて新契約されるんじゃないの？」と不安がられていましたが、下調べの段階でniftyのサポートは丁寧という評判を見ていたのでそこらへんは無問題でした。

問い合わせて、「先ほどタイプ2にした」ことを伝えたところ、

**別のルーターでv6プラスを使う設定にしている**

とのこと。

ちなみに家にあるHGW以外のルーターは、**IPv4 over IPv6に非対応**。

ということで、HGWでv6プラスのサービスを受けられるように、一旦v6プラスを解約し、再契約してみました。

## そして…

次の日模試を終え家に帰ってみると、[Path of Exile](https://store.steampowered.com/app/238960/Path_of_Exile/?l=japanese)の調子がいいと気分アゲアゲの親の姿が…

ちょっとルーター設定を確認してみると、

っ！？PPPoEの接続設定が変更できない！？

てことは…

**我が家にもIPv4 over IPv6が来たのか！！！**

やったー！！

[判定ツール](http://ipv6check.biglobe.ne.jp/)を用いて検査した結果も、ご覧の通り。  
![結果](/images/posts/2021-01/ipv6.png)

しかし、ポート開放したいのに、なかなか設定サービスが降ってこない…
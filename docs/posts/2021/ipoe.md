---
date: 2021-01-20
title: IPoEで詰まったところまとめ
outline: deep
description: 家の回線をIPoEにした時の、IPv4 over IPv6(所謂v6プラス)で詰まった部分の備忘録的somethingです。
next: false
prev: false
tags:
  - diary
---

今回家の回線をIPoEにしてみた時の備忘録的 something を残しておこうと思います。

(この記事はまだネットワークの知識が浅かった2021年初頭の記事を、ネットワークの知識がだいぶ身についた2024年1月9日に書き直したものです)

[[toc]]

## はじめに

通常IPv4はPPPoEと呼ばれる方式が用いられております。

PPPoE接続方式ではプロバイダ(ISP、インターネットへの接続を提供する)への通信量が多くなるとフレッツ網とISPをつなぐ網終端装置が輻輳し、回線速度の低下が発生します。

これは、[NTTの増設基準や設備予算によって、網終端装置の増強が簡単にできないこと](https://www.soumu.go.jp/main_content/000478903.pdf#page=16)が原因。

一方のIPoEは、IPv6のみの提供ではありますが、

フレッツ網とインターネットの接続は、NTT所有の網終端装置ではなく、IPoE接続事業者(VNE事業者。JPIXなど)が持つゲートウェイルーターで行います。

トラフィックの増加に伴うコストをVNE事業者が負担することで、NTTの変な縛りに拘束されずに回線速度を向上させることができるわけです。

### いざIPoE

IPoEの特徴の一つは、**設定はプロバイダがやってくれるから使用者は何もしなくていい**こと。

PPPoEからIPoEに変える際には
1. 既存のPPPoEプロバイダ設定を無効化または削除
2. ホームゲートウェイ(HGW)を再起動
3. **It's no STEP 3 lol**

## IPv4 over IPv6について

IPoE接続でIPv6しか使えなくなるとどうなるか……IPv4のみの接続しか提供しないウェブサービス、例えば**Twitter(現X)やDiscord等が使えなくなってしまいます**。

ほかにもv4にしか対応していないウェブサービスは数知れず。このままでは不便極まりないですね。

そこで使用するのが**IPv6 over IPv4**という技術で、IPv6を使い、MAP-E方式等によるトンネリングでIPv4を提供します[^1]。

IPv4 over IPv6の代表例、[v6プラス](https://www.jpne.co.jp/service/v6plus/)はJPIXが提供しており、JPIXの回線をリセールしている各社ISPのオプション機能で提供されます。

例えばわが家が契約する[nifty光でのv6プラスオプション](https://csoption.nifty.com/ipv6service/)とか。

v6プラスはIPoEを使うため、IPoEのメリットをそのまま引き継ぎます。つまり、**通信の品質ががVNE事業者依存となり、HGWの初期設定が要らない**というわけです。

## 元の回線契約が古いと……

わが家庭は、私が物心ついたときからブロードバンド接続を持っているインターネット老人ホーム。

こうなるとIPoEはできても、v6プラスはできないなんてことがあります。

ここからは回線契約の古さに起因する色々をご紹介。**大体が実際に引っかかった問題点です**。

### 光電話オプションの通信方式が古い

IPv4 over IPv6は「フレッツ・ジョイント」と呼ばれる機能によって配信[^2]されるそうです。

このフレッツ・ジョイントは光電話オプションの通信方式がタイプ2であるときにのみ使用可能ということで、**古いタイプ1を契約しているご家庭だとIPv4 over IPv6が使えない**ということになります。

最初v6プラスのサービスが降ってこないとき、親にけしかけてNTTに問い合わせたところ、

**タイプ1でした。**

**速攻でタイプ2にしてもらいました。**

**1時間かからずにタイプ2になりました。**

ちなみに、NTTのHGWを使っている方は、一部機能(例えばローカルDNS問い合わせ機能とか)の有無でタイプが見分けられます。

いろいろ便利なので、IPoEを使わなくても光電話はタイプ2のほうにしておきたいですね。

### HGWより先のルーターを配信先している

これは契約内容を確認してほしいのですが、HGWでのIPoE接続設定がONになっていない場合、**HGWよりローカルよりのルーターでMAP-Eが行われる用設定されているという問題が出てきます**。どういうこと？

大体は、先述の「光電話オプションの通信方式が古い」状態で追いv6プラスすると発生する現象っぽい感じ。

タイプ2にしてもらったうえで、ISPに問い合わせの上v6プラスを再契約することで、1日ほどすれば直ります。

## v6プラスになった後の問題点～サーバー管理者視点～

v6プラスは、1つのIPv4アドレスを複数の契約者で使っている感じが近いです。

そのため、**システムポートは尚のこと、1024番以降も限られたポートしか使用できません。**

(ちなみに使用可能なポートはIPv6アドレスで逆引きが可能です。)

IPv4でしか配信されないwebサービスが多いのと同じように、IPv4でしか接続できないクライアントも少なくない現状。これはかなり痛い。

どうしても80と443を開けなきゃいけないウェブサーバー等を建てる際は、IPv6でポート開放し、CloudflareにプロキシしてもらうことでIPv4の方にも見てもらえます。

### IPv4のポート開放の設定が降ってこない

無事v6プラスも使えるようになったけど、すぐに降って来たのはMAP-E用のソフトだけで、各種設定(パケットフィルタ設定や静的NAPT設定)はできないということが発生する場合があります。

これは**待ちましょう**。半年から1年あれば降ってきます。

[^1]: 平たく言えば「IPv6パケットの中身を覗いてみたら、IPv4パケットが入ってた！」というのがMAP-E方式です。
[^2]: MAP-EはルーターやHGWでNAPTを行う必要があり、それを行うためのソフトを配信するのに「フレッツ・ジョイント」が必要となります。
